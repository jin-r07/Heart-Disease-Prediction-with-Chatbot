<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <link rel="icon" type="image/x-icon" href="../static/assets/logo.png">
    <link rel="stylesheet" type="text/css" href="../static/settings.css">
    <script src="https://kit.fontawesome.com/cacd88a93b.js" crossorigin="anonymous"></script>
    <title>Settings - Heart Disease Prediction ChatBot</title>
</head>
<body>
<div class="container">
    <div class="vertical-navbar">
        <div class="logo">
            <img src="../static/assets/logo.png" alt="Logo"><h4>Account</h4>
        </div>
        <nav>
            <ul>
                <li class="link"><a href="#home" class="active"><i class="fa-solid fa-circle-user"></i>Account</a></li>
                <li class="link"><a href="#account"><i class="fa-solid fa-id-card"></i>Personal info</a></li>
                <li class="link"><a href="#password"><i class="fa-solid fa-key"></i>Password</a></li>
                <li><a href="/"><i class="fa-regular fa-circle-left"></i>Back to Home</a></li>
            </ul>
        </nav>
    </div>

    <div class="content">
        <div class="home" id="home">
            <img src="{{ profile_picture }}" alt="User">
            <h3>Welcome, {{ userName }}</h3>
            <p>Below, you can view your heart disease prediction history. You can also manage your account info and improve your privacy by changing your password. We keep your information private, safe and secure. <a href="/help">Learn more <i class="fa-regular fa-circle-question"></i></a></p>
            <div class="history">
                <h1>Prediction History:</h1><h2>Predictions generated by this application may produce inaccurate results, it should always be verified and
                confirmed by a qualified healthcare professional.</h2>
                <table>
                    <thead>
                    <tr>
                        <th>Predict Date & Time:</th>
                        <th>Age:</th>
                        <th>Gender:</th>
                        <th>Blood Pressure:</th>
                        <th>Cholesterol:</th>
                        <th>Max.Heart Rate:</th>
                        <th>Status:</th>
                        <th>Remarks:</th>
                        <th>Result:</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for result in output %}
                    <tr>
                        <td>{{ result[15] }}</td>
                        <td>{{ result[1] }}</td>
                        <td>
                            {% if result[2] == 0 %}
                            Female
                            {% elif result[2] == 1 %}
                            Male
                            {% endif %}
                        </td>
                        <td>{{ result[4] }}</td>
                        <td>{{ result[5] }}</td>
                        <td>{{ result[8] }}</td>
                        <td>
                            {% if result[14] == 0 %}
                            Healthy
                            {% elif result[14] == 1 %}
                            Not Healthy
                            {% endif %}
                        </td>
                        <td>
                            {% if result[14] == 0 %}
                            <i class="fa-solid fa-heart"></i>
                            <i class="fa-solid fa-check"></i>
                            {% elif result[14] == 1 %}
                            <i class="fa-solid fa-heart"></i>
                            <i class="fa-solid fa-xmark"></i>
                            {% endif %}
                        </td>
                        <td>
                            {% if result[14] == 0 %}
                            No Heart Disease
                            {% elif result[14] == 1 %}
                            Heart Disease
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="account" id="account">
            <h1>Personal info</h1>
            <p>Personal info and option to change your personal details. You can make changes to this info, like your profile picture, Username and Email.</p>
            <form class="user" action="/settings" method="POST" enctype="multipart/form-data" onsubmit="return validateForm()">
                <span>"A profile picture helps personalize your account."</span>
                <div class="profile-picture-container">
                    <img src="{{ profile_picture }}" alt="User">
                    <div class="container">
                        <div class="button-wrap">
                            <label class="button" for="upload">Upload File</label>
                            <input name="profile" id="upload" type="file" onchange="validateImage()"><label>&nbsp;&nbsp;Change your profile picture:</label>
                        </div>
                    </div>
                    <p></p>
                </div>
                <div class="info">
                    <label class="field">Username:</label>
                    <input class="user-input" name="username" id="usernameInput" value="{{ userName }}" oninput="validateUsername()"><br>
                    <span id="usernameError" class="error"></span>

                    <label class="field">Email:</label>
                    <input class="user-input" name="email" id="emailInput" value="{{ email }}" type="email" oninput="validateEmail()"><br>
                    <span id="emailError" class="error"></span>
                </div>
                <button id="submit" disabled class="button2">
                    <span>Submit</span>
                </button>
            </form>
        </div>

        <div class="password" id="password">
            <h1>Change your password</h1>
            <p>Improve your privacy by changing your password</p>
            <form action="/settings" method="POST" onsubmit="return validateForm2()">
                <h2>Reset Password</h2>
                <label for="myInput2" class="label">
                    <input id="myInput2" class="input" name="password" placeholder="New Password" type="password" required oninput="validatePassword()">
                    <label class="wrapper">
                        <input id="togglePw_current" placeholder="Password" type="checkbox" onclick="showPassword('myInput2')">
                        <div class="checkmark"></div>
                    </label>
                </label><span id="passwordError" class="error"></span><br><br>

                <label for="myInput3" class="label">
                    <input id="myInput3" class="input" name="confirmPassword" placeholder="Confirm Password" type="password" required oninput="validateConfirmPassword()">
                    <label class="wrapper">
                        <input id="togglePw_1" placeholder="Password" type="checkbox" onclick="showPassword('myInput3')">
                        <div class="checkmark"></div>
                    </label>
                </label><span id="confirmPasswordError" class="error"></span><br>
                <button id="submitButton" class="cta" disabled>
                    <span>Submit</span>
                </button>
            </form>
        </div>
    </div>
</div>

<div id="customSuccess" class="success-container">
    <p id="customSuccessMessage"></p>
</div>

{% if alert_message3 %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        var alertMessage = "{{ alert_message3 }}";
        var customAlert = document.getElementById("customSuccess");
        var customAlertMessage = document.getElementById("customSuccessMessage");

        customAlertMessage.textContent = alertMessage;
        customAlert.classList.add("show");

        setTimeout(function () {
            customAlert.classList.remove("show");
        }, 5000);
    });
</script>
{% endif %}

<script>
    const navLinks = document.querySelectorAll(".link a");
    const homeDiv = document.getElementById("home");
    const accountDiv = document.getElementById("account");
    const passwordDiv = document.getElementById("password");
    const recommendLink = document.getElementById("recommend-link");

    accountDiv.style.display = "none";
    passwordDiv.style.display = "none";

    navLinks.forEach(link => {
        link.addEventListener('click', (event) => {
            event.preventDefault();

            navLinks.forEach(link => {
                link.classList.remove('active');
            });

            link.classList.add('active');

            if (link.href.endsWith("#home")) {
                homeDiv.style.display = "block";
                accountDiv.style.display = "none";
                passwordDiv.style.display = "none";
            } else if (link.href.endsWith("#account")) {
                homeDiv.style.display = "none";
                accountDiv.style.display = "block";
                passwordDiv.style.display = "none";
            } else if (link.href.endsWith("#password")) {
                homeDiv.style.display = "none";
                accountDiv.style.display = "none";
                passwordDiv.style.display = "block";
            }
        });
    });

    recommendLink.addEventListener('click', (event) => {
        event.preventDefault();

        navLinks.forEach(link => {
            link.classList.remove('active');
        });

        recommendLink.classList.add('active');

        homeDiv.style.display = "none";
        accountDiv.style.display = "none";
        passwordDiv.style.display = "block";
    });

    function validateUsername() {
        let username = document.getElementById("usernameInput").value;
        let regexUN = /^[a-zA-Z0-9-_]+$/;
        if (username === "") {
            document.getElementById("usernameError").textContent = "Username Required";
            return false;
        } else if (username.length < 4) {
            document.getElementById("usernameError").textContent = "Username must be at least 4 characters long";
            return false;
        } else if (username.length > 20) {
            document.getElementById("usernameError").textContent = "Username must be less than 20 characters";
            return false;
        } else if (!regexUN.test(username)) {
            document.getElementById("usernameError").textContent = "Except ( _ - ), spaces or special characters are not allowed";
            return false;
        } else {
            document.getElementById("usernameError").textContent = "";
            enableSubmitButton();
            return true;
        }
    }

    function validateEmail() {
        let email = document.getElementById("emailInput").value;
        let regexE = /^([a-zA-Z0-9])+@(([a-zA-Z0-9])+\.)+([a-zA-Z0-9]{2,4})+$/;
        if (email === "") {
            document.getElementById("emailError").textContent = "Email Required";
            return false;
        } else if (!regexE.test(email)) {
            document.getElementById("emailError").textContent = "Invalid email address";
            return false;
        } else {
            document.getElementById("emailError").textContent = "";
            enableSubmitButton();
            return true;
        }
    }

    function validatePassword() {
        let password = document.getElementById("myInput2").value;
        if (password === "") {
            document.getElementById("passwordError").textContent = "Password Required";
            return false;
        } else if (password.length < 8) {
            document.getElementById("passwordError").textContent = "Password must be at least 8 characters long";
            return false;
        } else if (!/[A-Z]/.test(password)) {
            document.getElementById("passwordError").textContent = "At least one uppercase letter required";
            return false;
        } else if (!/[!@#$%^&*()_+]/.test(password)) {
            document.getElementById("passwordError").textContent = "At least one special character required";
            return false;
        } else {
            document.getElementById("passwordError").textContent = "";
            enableSubmitButton();
            return true;
        }
    }

    function validateConfirmPassword() {
        let password = document.getElementById("myInput2").value;
        let confirmPassword = document.getElementById("myInput3").value;
        if (confirmPassword === "") {
            document.getElementById("confirmPasswordError").textContent = "Confirm Password Required";
            return false;
        } else if (password !== confirmPassword) {
            document.getElementById("confirmPasswordError").textContent = "Passwords do not match";
            return false;
        } else {
            document.getElementById("confirmPasswordError").textContent = "";
            enableSubmitButton();
            return true;
        }
    }

    const fileInput = document.getElementById('avatar');

    fileInput.addEventListener('change', function() {
        const file = fileInput.files[0];
        const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg'];

        if (file && !allowedTypes.includes(file.type)) {
            alert('Please choose a PNG, JPEG, or JPG image');
            fileInput.value = '';
        }
    });

    function showPassword(targetID) {
        const x = document.getElementById(targetID);
        if (x.type === "password") {
            x.type = "text";
        } else {
            x.type = "password";
        }
    }

    function validateImage() {
        const fileInput = document.getElementById("upload");
        const file = fileInput.files[0];
        const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg'];
        const maxSizeInBytes = 10 * 1024 * 1024;

        if (!allowedTypes.includes(file.type)) {
            alert('Please choose a PNG, JPEG, or JPG image.');
            return false;
        } else if (file.size > maxSizeInBytes) {
            alert('Image size should be less than 10MB.');
            return false;
        } else {
            enableSubmitButton();
            return true;
        }
    }

    function validateForm() {
        if (
            validateUsername() &&
            validateEmail() &&
            validateImage()
        ) {
            return true;
        } else {
            return false;
        }
    }

    function validateForm2() {
        if (
            validatePassword() &&
            validateConfirmPassword() &&
            matchPasswords()
        ) {
            return true;
        } else {
            return false;
        }
    }

    function matchPasswords() {
        let password = document.getElementById("myInput2").value;
        let confirmPassword = document.getElementById("myInput3").value;

        if (password !== confirmPassword) {
            return false;
        } else {
            return true;
        }
    }

    function enableSubmitButton() {
        let userNameError = document.getElementById("usernameError").textContent;
        let emailError = document.getElementById("emailError").textContent;
        let passwordError = document.getElementById("passwordError").textContent;
        let confirmPasswordError = document.getElementById("confirmPasswordError").textContent;
        let submitButton = document.getElementById("submitButton");
        let submit = document.getElementById("submit");

        if (userNameError === "" || emailError === "" || passwordError === "" && confirmPasswordError === "") {
            submit.disabled = false;
            submitButton.disabled = false;
        } else {
            submit.disabled = true;
            submitButton.disabled = true;
        }
    }

    const showMoreButton = document.querySelector('.show_more');
    const moreDiv = document.querySelector('.more');

    showMoreButton.addEventListener('click', function() {
        if (moreDiv.style.display === 'none' || moreDiv.style.display === '') {
            moreDiv.style.display = 'block';
        } else {
            moreDiv.style.display = 'none';
        }
    });
</script>
</body>
</html>
